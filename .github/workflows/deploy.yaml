name: Full Stack CI/CD with Backup & Monitoring

on:
  push:
    branches: ["main"]

jobs:

  # ───────────────────────────────
  # FRONTEND PIPELINE
  # ───────────────────────────────
  deploy-frontend:
    name: Build + Deploy Frontend to EC2 + S3 Backup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies & build frontend
        run: |
          cd client
          npm install
          npm run build

      # Deploy to Frontend EC2
      - name: Deploy frontend to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_FRONTEND_HOST }}
          username: ${{ secrets.EC2_FRONTEND_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /var/www/frontend
            git reset --hard
            git pull origin main
            npm install
            npm run build
            pm2 restart frontend || pm2 start dist/index.html --name frontend
            pm2 save

      # Backup frontend to S3
      - name: Backup Frontend to S3
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --delete
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_FRONTEND_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SOURCE_DIR: "./client/dist"

      # CloudFront cache invalidation
      - name: CloudFront Invalidate Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DIST_ID }} \
            --paths "/*"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # Check frontend logs
      - name: Check frontend PM2 logs
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_FRONTEND_HOST }}
          username: ${{ secrets.EC2_FRONTEND_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            pm2 logs frontend --lines 20

  # ───────────────────────────────
  # BACKEND PIPELINE
  # ───────────────────────────────
  deploy-backend:
    name: Build, Test & Deploy Backend to EC2 + CloudWatch Setup
    runs-on: ubuntu-latest
    needs: deploy-frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies & run tests
        run: |
          cd server
          npm install
          npm test

      # Deploy backend to EC2
      - name: Deploy backend to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_BACKEND_HOST }}
          username: ${{ secrets.EC2_BACKEND_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /var/www/backend
            git reset --hard
            git pull origin main
            npm install
            pm2 restart backend || pm2 start index.js --name backend
            pm2 save

      # Setup CloudWatch monitoring (Linux EC2 + Node.js)
      - name: Setup CloudWatch Agent for Backend
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_BACKEND_HOST }}
          username: ${{ secrets.EC2_BACKEND_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            sudo yum install -y amazon-cloudwatch-agent
            sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
              -a fetch-config -m ec2 -c ssm:AmazonCloudWatchAgent -s
            pm2 logs backend --lines 20

  # ───────────────────────────────
  # NOTIFICATION PIPELINE
  # ───────────────────────────────
  notify:
    name: Deployment Status Notification
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: workflow,job,commit,repo,ref
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

